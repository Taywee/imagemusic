import init, { song_from_toml, song_free, song_samples, samples_free, samples_next } from './pkg/imagemusic.js';

const bloody_tears = `
ticks_per_second = 576.0

[[voice]]
notes = '''
160r 160des4 160fes4 160r 160des4 160fes4 160r 160des4 160fes4 160r 160des4 160fes4 160r 160des4 160fes4 160r 160des4 160fes4 160r 160des4 160fes4 160r 160des4 160fes4 160a3 160des4 160fes4 160a3 160des4 160fes4 320a3 160d4 160ges4 160a3 160d4 160ges4 160r 160c4 160ges4 160r 160des4 160fes4 160r 160des4 160es4 160r 160c4 160es4 960r 480r 240r 120r 120as4 1440as4 480as4 960as4 960a4 960as4 480ges4 480ces5 160ces4 320fes4 160fes4 160r 160ces4 160fes4 160r 160ces4 160fes4 160r 160ces4 160fes4 960r 480r 240r 120r 120g4 1440g4 480g4 1440g4 480ges4 960ges4 480g4 480fes4 960ges4 960ges4 960r 480r 480ces5 1440c5 480r 160ces4 160es4 160ges4 1440ces5 160ces4 160es4 160ges4 1440c5 480r 960r 960ces5 960ces5 960r 960g4 960ges4 960des4 960r 960r 480r 360des5 120des5 480r 160des4 160as4 160ces5 480r 360des5 120des5 480r 160r 160ges4 160a4 480c5 480des5 1440es5 480r 960r 480es5 480r 480c5 480as4 480a4 480ges4 960r 480a3 480r 480r 480des5 480fes5 480des5 480r 480des4 480fes4 480des4 160r 160a3 160r 160c4 160a3 160es4 160c4 160ges4 160es4 160a4 160ges4 160c5 160r 160des4 160r 160fes4 160des4 160as4 160fes4 160des5 160as4 160fes5 160des5 160as4 160des4 160g4 160fes4 160bes4 160g4 160des5 160bes4 160fes5 160des5 160g5 160fes5 160bes5 160ges4 160c5 160a4 160es5 160c5 160ges5 160es5 160a5 160ges5 160c6 160a5 160es6 160c6 160ges5 160a5 160es5 160ges5 160c5 160es5 160a4 160c5 160ges4 160a4 160es4 160ges4 160c4 160es4 160a3 160c4 160r 480a3 320r 160a3 480r 480a3 320r 160a3 320r 160a3 480r 480a3 320r 160a3 320r 160a3 480r 480a3 320r 160des4 320r 160des4 160r 160a3 160des4 160r 160a3 160des4 320r 160c4 320r 160c4 960r 480r 240r 120r 120as4 1440as4 480as4 960as4 960a4 960r 480r 480ces5 960r 480r 360ces5 120ces5 160ces4 160ges4 160a4 1440ces5 160ces4 160ges4 160a4 480r 160ces4 160fes4 160as4 480c5 480des5 160es4 160ges4 160as4 960es5 160fes4 160as4 160des5 960fes5 160d4 160ges4 160a4 960d5 160c4 160ges4 160as4 960c5 160des4 160fes4 160as4 1440des5 160des4 160f4 160as4 1440d5 480r 160des4 160f4 160as4 1440des5 160des4 160f4 160as4 1440d5 480r 160des4 160f4 160as4 960des5 160des4 160ges4 160a4 960des5 480r 160ces4 160ges4 160a4 160ces4 160ges4 160a4 480ces5 480a4 480a4 480as4 480as4 960ges4 480as4 480a4 960as4 480as4 480r 320des4 160des4 160r 160des4 160fes4 160r 160des4 160fes4 160r 160des4 160fes4 160r 160es4 160ges4 160r 160es4 160ges4 160r 160es4 160ges4 160r 160es4 160ges4 160r 160fes4 160des4 160as4 160fes4 160des5 160as4 160fes5 160des5 160as5 160fes5 160des5 160c5 160es5 160a4 160c5 160ges4 160a4 160es4 160ges4 160a3 480c4 160des4 160fes4 160des4 160as4 160fes4 160des5 160as4 160fes5 160des5 160as5 160fes5 160des5 160c5 160es5 160a4 160c5 160ges4 160a4 160es4 160ges4 160a3 480c4 320des4 160des4 160fes4 160des4 160r 480r 480des4 1920r 960r 960des4 1920des4
'''

[[voice]]
notes = '''
480r 480r 480r 480r 960r 480r 480as4 960r 120r 240es4 120ges4 240r 120r 120as4 137r 206des4 137fes4 69r 69r 206des4 137fes4 137a3 206des4 137ges4 137a3 206des4 137ges4 137r 206ces4 137fes4 69r 69r 206ces4 137fes4 171a3 137ces4 137es4 34a3 160r 160ces4 160es4 480r 960r 480r 480g4 960r 120r 240ces4 120f4 240r 120r 120g4 960r 120r 240des4 120fes4 480r 137r 206ces4 137d4 69r 69r 206ces4 137d4 160r 160ces4 160des4 160r 160ces4 160des4 137r 206ces4 137d4 69r 69r 206ces4 137d4 137r 206bes3 137des4 69r 69r 206bes3 137des4 160ces4 160d4 160ges4 160ces4 160d4 160ges4 160ces4 160es4 160ges4 160ces4 160es4 160ges4 480ces4 160r 160fes4 160g4 160ces4 160fes4 160g4 480bes4 480r 160ces4 160es4 160ges4 160ces4 160es4 160ges4 480ces5 160r 160fes4 160g4 480r 480r 160ces4 160fes4 160g4 160ces4 160es4 160ges4 960ces5 160ces4 160d4 160f4 480r 160ces4 160des4 160as4 480r 160a3 160des4 160ges4 960a4 137r 206ces4 137d4 69r 69r 206ces4 137d4 137r 206a3 137es4 69r 69r 206a3 137es4 320r 160a3 480r 480des4 480des4 160r 160a3 160des4 160a3 160des4 160ges4 160des4 160ges4 160a4 160des4 160ges4 160a4 160des4 160as4 160ces5 960des5 160des4 160as4 160ces5 160des4 160as4 160ces5 160des4 160ges4 160a4 960des5 160c4 160ges4 160a4 160des4 160ges4 160a4 480r 160es4 160ges4 160as4 160es4 160ges4 160as4 480es5 160fes4 160as4 160des5 1440fes5 160des4 160fes4 160bes4 160r 160c4 160es4 160r 160c4 160es4 160r 160c4 160es4 160r 160c4 160es4 480r 160r 160fes4 160as4 160r 160fes4 160as4 160r 160fes4 160as4 160r 160fes4 160as4 480r 480r 480r 480r 480r 480r 480r 480r 480r 480r 480r 320r 160des4 160r 160des4 160fes4 160r 160des4 160fes4 160des4 320as4 160fes4 960r 120r 240es4 120ges4 240r 120r 120as4 137r 206des4 137fes4 69r 69r 206des4 137fes4 137a3 206des4 137ges4 137a3 206des4 137ges4 960as4 480ges4 480a3 160ces4 320fes4 160fes4 160ces4 160fes4 160as4 160ces4 160fes4 160as4 160ces4 160fes4 160as4 480r 160ces4 160ges4 160a4 160ces4 160ges4 160a4 360ces5 120ces5 160ces4 160fes4 160as4 960ces5 160c4 160ges4 160as4 160des4 160fes4 160as4 480r 160es4 160ges4 160as4 480r 160fes4 160as4 160des5 480r 160d4 160ges4 160a4 480r 160c4 160ges4 160as4 480r 160des4 160fes4 160as4 160des4 160f4 160as4 480des5 160r 160ges4 160a4 480r 480r 160des4 160ges4 160a4 480r 160des4 160f4 160as4 160des4 160f4 160as4 480des5 160r 160ges4 160a4 480r 480r 160des4 160ges4 160a4 480r 160des4 160f4 160as4 480r 160des4 160ges4 160a4 160ces4 160ges4 160a4 1440ces5 160ces4 160fes4 160as4 160a3 160fes4 160as4 160a3 160es4 160ges4 160r 160es4 160ges4 160r 160des4 160fes4 137r 206des4 137es4 69r 69r 206des4 137es4 160r 160des4 160es4 160a3 160des4 160es4 137r 206des4 137fes4 69r 69r 206des4 137fes4 160r 160c4 160es4 160r 160c4 160es4 480r 480r 480r 480r 480r 480r 480r 480r 480r 480r
'''

[[voice]]
notes = '''
480r 480r 480r 480r 320r 160des4 160r 160des4 160fes4 160r 160des4 160fes4 160r 160des4 160fes4 137r 206es4 137ges4 69r 69r 206es4 137ges4 480r 160r 160es4 160ges4 480r 480r 480r 160r 160ces4 160fes4 160r 160ces4 160fes4 160r 160ces4 160fes4 160r 160ces4 160fes4 137r 206ces4 137f4 69r 69r 206ces4 137f4 480r 160r 160ces4 160f4 137r 206c4 137fes4 69r 69r 206ces4 137fes4 480r 160r 160des4 160fes4 480r 480r 480r 160r 160fes4 160g4 480ces4 480r 160ces4 160fes4 160g4 480r 480ces4 160ces4 160fes4 160g4 160ces4 160fes4 160g4 480bes4 480r 160ces4 160es4 160ges4 480r 160ces4 160d4 160f4 480r 160ces4 160des4 160as4 480r 160a3 160des4 160ges4 480r 480r 240r 120r 120a3 960r 480r 480r 480r 480des4 960r 160es4 160ges4 160as4 480r 480r 160es4 160ges4 160as4 480r 160fes4 160as4 160des5 160es4 160ges4 160a4 480des5 480r 480r 480r 480r 480r 480r 480r 480r 480r 480r 480r 480r 480r 480r 480r 137r 206es4 137ges4 69r 69r 206es4 137ges4 480r 160r 160es4 160ges4 480r 137r 206ces4 137fes4 69r 69r 206ces4 137fes4 160a3 160ces4 160es4 160r 160ces4 160es4 480r 480r 480r 480r 480r 480r 480des4 160des4 160ges4 160a4 160des4 160ges4 160a4 480c5 480r 480des4 160des4 160ges4 160a4 160des4 160ges4 160a4 480c5 480r 480r 480r 480r 480r 480r 480r 480r 480r 480r 480r 480r 480r 480r 480r
'''

[[voice]]
notes = '''
480r 480r 480r 480r 480r 480r 480r 480r 480r 480r 480r 480r 480r 480r 480r 480r 480r 480r 480r 480r 480r 480r 480r 480r 480r 480r 480r 480r 480r 480r 480r 480r 480r 480r 480r 480r 480r 480r 480r 480r 480r 480r 480r 480r 480r 480r 480r 480r 480r 480r 480r 960r 480a3 480r 480r 960r 480a3 480r 480r 480r 480r 480r 480r 480r 480r 480r 480r 480r 480r 480r 480r 480r 480r
'''

[[voice]]
notes = '''
480as3 480r 960r 480as3 480r 960r 960a1 960a2 960ges1 960ges2 480as3 480r 960r 480r 480as3 480as3 480as3 480as3 480as3 480as3 480as3 480as3 480as3 960ges1 960ges2 480as3 480as3 960ces2 960ces3 480as3 480as3 480as3 480as3 480g3 480g3 480g3 480g3 480g3 480g3 480g3 480g3 480c2 480c3 480g3 480ces2 480ces3 480g3 480g3 480ges3 480ges3 480ges3 480fes2 480g3 480g2 480fes3 480ges3 480ges3 480ges3 480ges3 2400ces2 2400ces3 480fes2 480fes3 480g2 480g3 480fes2 480fes3 2400ces2 2400ces3 480fes2 480fes3 480g2 480g3 480fes2 480fes3 960ces2 960ces3 960as1 960as2 960f1 960f2 960ges1 960ges2 480g3 480g3 480ges3 480ges3 160des3 160ges3 160r 160des3 320ges3 160des3 160ges3 160as3 160des2 160des3 160f3 160as3 480ges3 480r 960r 1920f2 1920des3 1920f3 960ges2 960ges3 480es2 480es3 480des2 480des3 1440c2 1440as2 1440c3 480c2 480as2 480c3 960des2 960as2 960des3 480ges1 480ges2 480g1 480g2 1920as1 1920as2 160r 160c3 160es3 480as3 480r 480ges3 480fes3 480r 960r 640r 320fes3 320r 640as3 160es3 160r 160ges3 480r 960r 160fes3 160r 160as3 480r 960r 1920as1 1920as2 1920r 1920r 480r 320r 160ges3 160r 320es3 160ges3 320des3 160ges3 160r 137r 206ges3 137as3 69r 69r 206as3 137ges3 480es3 480des3 137r 206ges3 137as3 69r 69r 206as3 137ges3 480d3 480des3 137r 206ges3 137as3 69r 69r 206as3 137ges3 160r 160fes3 160r 480r 480es3 480es3 160es3 160as3 160r 160es3 320ges3 480r 480as3 480as3 480as3 480as3 480r 960r 480as3 480r 960r 480as3 480r 960r 480as3 480r 960r 1920es2 1920es3 960fes2 960fes3 480es2 480es3 480des2 480des3 960c2 960as2 960c3 480des2 480as2 480des3 480r 960ges1 960ges2 960as1 960as2 2400des2 2400des3 480ges2 480ges3 480a2 480ges2 480ges3 2400des2 2400des3 480ges2 480ges3 480a2 480ges2 480ges3 960des2 960des3 960ges1 960ges2 1440es2 1440es3 480fes2 480fes3 480des2 480des3 480es2 480es3 480c2 480c3 480as3 480des2 480des3 480as3 480ges3 480r 960r 960as1 960as2 480as3 480ges3 480ges3 160fes3 160as3 160r 480r 960r 480as3 480as3 480as3 360as2 360as3 120as2 480as3 480r 480r 360as2 120as2 1440as1 1440as2 160r 160as3 160ges3 480fes3 480r 480r 360as2 120as2 1440as1 1440as2 160r 160as3 160ges3 960r 480r 120r 240as3 120fes3 1920r 960des2 960des2 960as2 960des3 960fes3 960as3 1920des2 1920as2 1920des3 1920fes3 1920as3
'''

[[voice]]
notes = '''
480as3 480as3 2880des2 2880des3 480as3 480as3 480as3 2880ces2 2880ces3 480as3 480r 960as1 960as2 480as3 480as1 480as2 480as3 480ges3 160fes3 160as3 2560des2 2560as2 2560des3 1920c2 1920as2 1920c3 960des2 960des3 960r 960ces2 960ces3 960r 1920fes2 1920fes3 1920fes2 1920fes3 1920d2 1920d3 960r 960bes1 960bes2 960ces2 960ces3 960r 960ges2 960ges1 960ges2 480r 480r 480r 480r 480r 480r 960ces2 960ces3 960c2 960c3 960des2 480des2 480r 1920ges1 1920des2 1920ges2 480r 480r 480r 480r 480r 480r 160r 160c3 160es3 120r 240c3 120es3 160r 160c3 160es3 1920as1 1920as2 137r 137fes3 274as3 274r 137as3 137r 274fes3 274r 137fes3 137as3 1920as1 1920as2 1920as1 1920as2 480r 7680as1 7680as2 960c3 120r 360ges3 120r 360ges3 960c3 120r 360ges3 120r 360ges3 960as2 960c3 480des3 120des3 360fes3 960ges1 960ges2 960as1 960as2 160fes3 160as3 160r 480r 960r 480as3 480as3 3840c2 3840as2 3840c3 480as3 960des2 960des3 480as3 960ges1 960ges2 960ces2 960ces3 480as3 960ces2 960ces3 1920fes2 1920fes3 480r 480r 480r 480r 480r 480r 480r 480r 480r 480r 480r 960a1 960a2 480ges3 480as1 480as2 480as3 480ges1 480ges2 480as3 480r 960as1 960as2 480r 480as3 480as3 360as2 360as3 120as2 1440as2 1920c2 1440as2 1920des2 960r 480r 240r 120r 120as2 1440des2 1440as2 480r 960r 480r 240r 120r 120as2 480r 240r 120r 120as3 160r 160fes3 160as3 480r 480as2 480r 960r 480r 480r
'''

[[voice]]
notes = '''
480r 480r 480r 480r 480r 480r 480r 480r 480r 480r 480r 480r 480r 480r 480r 480r 480r 480r 480r 480r 480r 480r 480r 480r 480r 480r 480r 480r 1920as1 1920as2 480r 1920as2 480r 480r 480r 480r 480r 480r 1920as1 1920as2 1920as1 1920as2 960as1 960a1 960a2 480r 1920des2 1920as2 1920des3 480r 480r 480r 480r 480r 480r 480r 480r 480r 480r 480r 480r 480r 480r 480r 480r 480r 1440as2 1920des2 480r 480r 960r 480r 480as2 480r 960r 480r 480as2 160fes3 160as3 160r 480r 960des3 160r 160des3 160fes3 160as3 160fes3 160des3 160as2 160des3 160as2 160fes2 160as2 160fes2 480r 480r
'''

[[voice]]
notes = '''
480r 480r 480r 480r 480r 480r 480r 480r 480r 480r 480r 480r 480r 480r 480r 480r 480r 480r 480r 480r 480r 480r 480r 480r 480r 480r 480r 480r 480r 480r 1920as1 480r 480r 480r 480r 480r 480r 480r 480r 480r 480r 480r 480r 480r 480r 480r 480r 480r 480r 480r 480r 480r 480r 480r 480r 480r 480r 480r 480r 480r 480r 480r 480r 480r 480r 960as2 3840des2 480r 480r
'''
`;

async function run() {
    await init();

    const audioCtx = new window.AudioContext();

    const song = song_from_toml(bloody_tears);

    let max_amplitude: number = 0.0;
    let total_samples = 0;
    let sample: number;
    let samples = song_samples(song, audioCtx.sampleRate);
    console.log('Analyzing samples');
    while ((sample = samples_next(samples)) !== null) {
        let amplitude = Math.abs(sample);
        if (amplitude > max_amplitude) {
            max_amplitude = amplitude;
        }
        total_samples += 1;
    }
    console.log('Done analyzing samples');
    samples_free(samples);

    const myArrayBuffer = audioCtx.createBuffer(1, total_samples, audioCtx.sampleRate);
    const channel = myArrayBuffer.getChannelData(0);

    // Find the reciprocal so that we can get the samples through multiplication
    // instead of division
    const boost = 1.0 / max_amplitude;
    samples = song_samples(song, audioCtx.sampleRate);
    let i = 0;
    console.log('Filling buffer');
    while ((sample = samples_next(samples)) !== null) {
        channel[i] = sample * boost;
        i += 1;
    }
    console.log('Filled buffer');
    samples_free(samples);

    song_free(song);

    const source = audioCtx.createBufferSource();
    source.buffer = myArrayBuffer;
    source.connect(audioCtx.destination);
    source.start();
}

run();
